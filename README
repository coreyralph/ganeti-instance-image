ganeti-instance-image
=====================

This is a guest OS definition for Ganeti (http://code.google.com/p/ganeti). It
will install a Linux-based image using either a tarball or qemu-img disk image
file. This definition also allows for manual creation of an instance by simply
setting only the disks up and allowing you to boot via the install cd manually.
The goal of this instance is to allow fast and flexible installation of
instances without the need for external tools such as deboostrap.

Installation
------------

In order to install this package from source, you need to determine what options
ganeti itself has been configured with. If ganeti was built directly from
source, then the only place it looks for OS definitions is ``/srv/ganeti/os``,
and you need to install the OS under it::

  ./configure --prefix=/usr --localstatedir=/var \
    --sysconfdir=/etc \
    --with-os-dir=/srv/ganeti/os
  make && make install

If ganeti was installed from a package, its default OS path should already
include /usr/share/ganeti/os, so you can just run::

  ./configure -prefix=/usr --localstatedir=/var \
    --sysconfdir=/etc
  make && make install

Note that you need to repeat this procedure on all nodes of the cluster.

The actual path that ganeti has been installed with can be determined by looking
for a file named _autoconf.py under a ganeti directory in the python modules
tree (e.g.  ``/usr/lib/python2.4/site-packages/ganeti/_autoconf.py``). In this
file, a variable named OS_SEARCH_PATH will list all the directories in which
ganeti will look for OS definitions.

Configuration of instance creation
----------------------------------

The kind of instance created can be customized via a settings file. This file
may or may not be installed by default, as the instance creation will work
without it. The creation scripts will look for it in
``$sysconfdir/default/ganeti-instance-image``, so if you have run configure with
the parameter ``--sysconfdir=/etc``, the final filename will be
``/etc/default/ganeti-instance-image``.

The following settings will be examined in this file:

- CDINSTALL:  If 'yes' only setup disks for a cd based install or manual
              installation via other means. It will not deploy any images or
              create any partitions. (default: no)
- SWAP:       Create a swap partition (tarball only) (default: yes)
- IMAGE_NAME: Name for the image to use. Generally they will have names similar
              to: centos-5.4, debian-5.0, etc. The naming is free form depending
              on what you name the file itself.
- IMAGE_TYPE: Create instance by either using a gzipped tarball or an image
              created by qemu-img. Accepts either 'tarball' or 'qemu'.
              (default: qemu).
- IMAGE_DIR:  Override default location for images.
              (default: ``$localstatedir/cache/ganeti-instance-image``)
- ARCH:       Define the architecture of the image to use. Accepts either 'x86'
              or 'x86_64'.
- CUSTOMIZE_DIR: A directory containing customization script for the instance.
              (by default $sysconfdir/ganeti/instance-image.d) See
              "Customization of the instance" below.
- IMAGE_DEBUG: Enable verbose output for instance scripts.

Note that the settings file is important on the node that the instance is
installed on, not the cluster master. This is indeed not a very good model of
using this OS but currently the OS interface in ganeti is limiting.

Creation of Deployment Images
-----------------------------

There are two types that are supported for deploying images.

Tarball
~~~~~~~

Tarball based images are quite simply a tarball of a working system. An good
example use case for this is deploying a Gentoo instance using a stage4 tarball.
The only requirement is that the tarball is gzipped instead of bzip2 for speed.
If you wish use a kernel inside of the VM instead of externally, make sure that
a working kernel, grub config are install in the tarball. Enable the 'grub'
custom script to install the grub boot image during installation.

Qemu Images
~~~~~~~~~~~

To create a new qemu based disk image, you will need to able the 'CDINSTALL'
option and install the VM using the distro's provided installation medium. It is
not recommended to build images on systems outside of ganeti (such as libvirt)
as we have encountered issues with systems segfaulting.

Once the instance has been created, boot the instance and point it to the
install medium:

 gnt-instance start -H cdrom_image_path=path/to/iso/ubuntu-9.10.iso, \
    boot_order=cdrom instance-name

Once the base image has been installed, ensure you have the acpid package
installed so that ganeti can shutdown the VM properly. Once you are happy with
your base image, shutdown the VM, activate the disks,  and create the disk
image using qemu-img. Its recommended you use qcow2 with compression to reduce
the amount of disk space used.

 # activate disks
 gnt-instance activate-disks instance-name
 # create image
 qemu-img convert -c -f host_device /dev/drbd1 \
    -O qcow2 $IMAGE_DIR/ubuntu-9.10-x86_64.img

Note: Older versions of qemu-img may not support the 'host_device' format so use
'raw' instead which should work in theory.

Image Naming
~~~~~~~~~~~~

The naming convention that is used is the following:

tarball:    $IMAGE_NAME-$ARCH.tar.gz
qemu-img:   $IMAGE_NAME-$ARCH.img

Customization of the instance
-----------------------------

If run-parts is in the os create script, and the CUSTOMIZE_DIR (by default
$sysconfdir/ganeti/instance-image.d, /etc/ganeti/instance-image.d if you
configured the os with --sysconfdir=/etc) directory exists any executable whose
name matches the run-parts execution rules (quoting run-parts(8): the names must
consist entirely of upper and lower case letters, digits, underscores, and
hyphens) is executed to allow further personalization of the installation. The
following environment variables are passed, in addition to the ones ganeti
passes to the OS scripts:

TARGET:     directory in which the filesystem is mounted
BLOCKDEV:   ganeti block device
ROOT_DEV:   device in which the root (/) filesystem resides (the one mounted in
            TARGET)
BOOT_DEV:   device in which the boot (/boot) filesystem resides

The scripts in CUSTOMIZE_DIR can exit with an error code to signal an error in
the instance creation, should they fail.

The scripts in CUSTOMIZE_DIR should not start any long-term processes or daemons
using this directory, otherwise the installation will fail because it won't be
able to umount the filesystem from the directory, and hand the instance back to
Ganeti.

# vi: set tw=80 ft=rst :
